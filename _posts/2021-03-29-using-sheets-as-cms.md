---
layout: post
title:  "Пример использования Apps Script для создания админки/системы менеджмента контента"
---

## Вводная

На Шедоуране встала задача: мастера хотят иметь возможность начислять опыт персонажам "по списку" - есть список из нескольких десятков персонажей и положенного им количества опыта,
хочется этот список каким-то образом внести в IT-систему и раздать опыт. Списков потенциально может быть несколько, хочется чтоб можно было делать всякие операции вроде
"Задать группу персонажей из Пети, Васи и Кати, сохранить как Список#1... Выдать всем из Списка#1 по 10 опыта.". Хочется каким-то понятным образом эти списки просматривать,
редактировать... и прочие подобные хотелки.

В IT-системе уже есть возможность выдать Х опыта персонажу номер Y (есть соответствующее REST API и даже web-админка).
Но делать групповые операции через него крайне неудобно - очень много ручной работы.

Как исходная задача решается в нормальном еnterprise программировании? Ну, мы собираем более подробное ТЗ/User Stories, чтоб понять чего пользователям на самом деле нужно
и какие приоритеты. Заводим таблички в базе данных с сущностями "Список персонажей" и т.п. Делаем какой-нибудь микросервис, который позволит осуществлять со всеми этими сущностями
стандартные CRUD-операции. Ну и заодно добавляем метод "начислить опыт", который уже зовет основную IT-систему. Ах да, еще делаем web-фронтенд, который будет собственно общаться
с нашим микросервисом. И не забываем прикрутить к нему авторизацию. А, да, еще придумываем где все это добро хостить.

Как лего догадаться, в случае программирования для РИ почти всегда на все вышеописанное нет времени (и зачастую желающих заниматься всей этой неблагодарной механической работой).
Что происходит в результате? Примеры из личного опыта:
* Заявляется "найдем больше игротехов, они как-нибудь справятся с тем, чтоб выдавать опыт каждому персонажу индивидуально через админку".
* Заявляется "найдем/обучим какого-нибудь из мастеров азам SQL, чтоб он мог все это делать с помощью вручную написанных SQL запросов".
* Предпринимается попытка сделать описанную выше enterprise-реализацию, но в силу дефицита времени - все делается через пень-колоду, страшно глючит и абсолютно не user-friendly.

Наверное, где-то в мире невидимых розовых пони в последнем пункте таки получается сделать классную админку с хорошим UX. Но я пока не встречал такого.

## Мое решение
Я уже довольно давно пиарю Google Sheets как систему менеджмента контента / задания структурированных данных мастерами. Т.е. мастера заполняют табличку, программист пишет скрипт,
который выкачивает (и по возможности валидирует) данные (и при необходимости засовывает их в нормальную БД). 

Плюсы этого метода:
* Какой-никакой интерфейс уже есть. Причем знакомый многим мастерам. И позволяющим типовые групповые операции, дающий возможности типа поиска и т.п.
* С авторизацией тоже проблем нет. С кем пошарили табличку - тот и мастер :)
* Если вдруг захочется, чтоб данные контента вычислялись по каким-то формулам, которые мастера хотят тюнить (чтоб свести баланс, например) - то (сюрприз!) делать вообще ничего не надо, писать формулы в Google Sheets умеет существенно больше людей, чем программировать.

На все том же Шедоуране названия, описания и разные числовые параметры абилок - задаются мастерами именно так. Поэтому я решил пойти немного дальше: убрать из схемы программиста,
запускающего скрипт. Тем более что с написанием этого скрипта все тоже не так просто - код там в целом тривиальный, но авторизация в Google Sheets из внешнего скрипта - 
не самое тривиальная штука (особенно если нет готового примера под рукой).

В итоге решение выглядит так:
1. Создаем гугл-табличку. Примерно [вот такую](https://docs.google.com/spreadsheets/d/1wgLKtTIWhN_Nlz52o-j24onbhPX071NXE9Di3vtO4Kc). 
2. Идем в Tools -> Script Editor.
3. <s>Рисуем остальную сову</s>. Тут нам таки придется написать немного кода. Что-нибудь [вроде такого](https://gist.github.com/aeremin/50c1588d4b1a92a403203e2f02776e96).
4. В табличке жмем Insert -> Drawing, рисуем что-нибудь кнопкообразное. Выделяем его, жмем на меню-три-точки, там Assign Scipt и указываем название нашей функции (`downloadQuotes` в моем примере).
5. Собственно все - можно кликать по нашей недокнопке и это запустит скрипт.

Внимательный читатель, конечно же, скажет что я его обманул - рассказал только как сделать часть про "пройтись по табличке, вызвать внешнее API, записать результаты в табличку".
А как же часть про "менеджмент списков персонажей"? А никак - ее в этом варианте можно просто не делать, мастера могут просто на отдельной вкладке/табличке редактировать списки
как захотят, а потом просто копировать 2 столбца на вкладку со скриптом. Кустарно, да. Но зато это решение реализуемое за пару часов, а не недель (что в реалиях ролевого программирования
следует читать как "не реализуемое вообще никогда").

