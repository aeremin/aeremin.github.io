---
layout: post
title:  "Индикация в телефоне vs индикация в окружающем мире"
---

Недавно написал в IT и РИ следующее:

> Вот кстати наброшу про функционал vs красоту - есть достаточно известное приложение 
> (кажется от Гендальфа) про взлом замков через сканирование qr-кодов и миниигру на телефоне.
> Типа сканируешь куар замка в котором зашита сложность и прочее, играешь в миниигру, 
> видишь результат на телефоне (взломал/не взломал). Ну и соответственное если взломал - то игнорируешь
> замок.
> 
> Вот как по мне - если замок это не просто куар, а куар + девайсик и индикация результата 
> взлома - не на телефоне, а на девайсе (например, телефон при сканировании куар-кода не 
> только запускает миниигру, а еще и цепляется к девайсу по блютусу и по итогам взлома посылает 
> команду какую-то) - это вот прямо принципиально лучше и магичнее. Хотя функционально разницы 
> почти никакой.

Что ж, раз написал, нужно демо запилить, чтоб показать что это не то чтоб очень сложно сделать.
Заодно обновил и почистил свое Ostranna-приложение.

<iframe width="560" height="315" src="https://www.youtube.com/embed/WU-AopSdobI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>

### Использованная технология: Deep Links

Можно заметить, что при сканировании QR-кода приложением камеры - содержимое отображается как ссылка,
но нажатие на нее не открывает браузер, а запускает приложение. Это сделано через т.н.
[Deep Links](https://developer.android.com/training/app-links/deep-linking) - Android-приложение может
зарегистрировать себя как обработчик/перехватчик ссылок определенного формата, и тогда при открытии такой ссылки
(из любого приложения на телефоне, будь то камера или Telegram) - откроется соответствующий ссылке
экран приложения. В данном случае ссылка содержит в себе MAC-адрес устройства, к которому мы подключаемся.
 
Чем все это важно/полезно:
* Такой перехват ссылки не требует подключения к интернету. В частности, не нужно чтоб эта ссылка вообще
  вела на реальную страницу.
* В свете жалоб на ролевые приложения и QR-коды формата "Игровое приложение не сканировало QR, а стандартным
  приложением камеры он сканировался" - через описанную технологию легко сделать так, чтоб стандартное
  приложение камеры было запасным вариантом - есть сканер в приложении, но при сканировании камерой и
  открытии ссылки - все тоже работает.
* Ничего не мешает сделать в игровом приложении скрытые экраны, в которые никак нельзя попасть средствами
  самого приложения, зато можно попасть через открытие секретной ссылки. Дальше можно эти ссылки выдавать
  игрокам как угодно - будь то QR-код или просто ссылки скинутые в мессенджер.

### Использованная технология: Bluetooth (точнее BLE)

Все общение с девайсом идет через Bluetooth. Не-фоновое взаимодействие с Bluetooth-устройствами в
Android'е довольно негеморройно (в данном случае используется библиотека [RxAndroidBle](https://github.com/dariuszseweryn/RxAndroidBle)).
В данном случае используется [кастомный девайс](https://ostranna.ru/gameengine/thefirefly/),
но должно быть не очень сложно подключить что-то угодно, управляемое по BLE.
Ради эксперимента заказал себе несколько диодных лент с алиэкспресса, как придут - проверю интеграцию с ними.

### Дополнительные ссылки
* [Репозиторий с Android-приложением](https://github.com/aeremin/ostranna_configurator)
* [Репозиторий с прошивками для светлячка](https://github.com/aeremin/firefly_zephyr)
